[ { "title": "初夏", "url": "/posts/chuxia/", "categories": "essay", "tags": "随笔", "date": "2022-05-20 12:14:52 +0800", "snippet": "罗衣轻解夜未央&amp;emsp;卧看星河映小窗&amp;emsp;欲揽清风入怀前&amp;emsp;夜半秋凉为君眠&amp;emsp;下南2022年5月20日于上海疫情封闭中" }, { "title": "树莓派+shadowsocks实现局域网科学上网", "url": "/posts/raspi-shadowsocks-proxy/", "categories": "Blogging, Tutorial", "tags": "树莓派, shadowsocks, dnsmasq", "date": "2022-04-01 21:05:02 +0800", "snippet": "准备工作树莓派的系统烧录就不在这里介绍了，网上一大堆资料需要的可以去找。这里假设你已经有了一个烧录好系统的树莓派。我这里使用的是树莓派4B，内存大小是2G,系统镜像是raspbian。想要实现的目的是所有连上家里路由器的设备都可以无感访问内外网。设备连接结构如下图所示:shadowsocks-libev安装配置sssudo apt-get updatesudo apt-get upgradesudo apt-get install shadowsocks-libev在/etc/shadowsocks-libev下创建shadowsocks的配置文件config.jsonsudo vim /etc/shadowsocks-libev/config.json填入以下内容:{ &quot;server&quot;:&quot;xxx.xxx.xxx.xxx&quot;, &quot;local_address&quot;:&quot;0.0.0.0&quot;, &quot;mode&quot;:&quot;tcp_and_udp&quot;, &quot;server_port&quot;:8888, &quot;local_port&quot;:1080, &quot;password&quot;:&quot;*****&quot;, &quot;timeout&quot;:60, &quot;method&quot;:&quot;chacha20-ietf&quot;} “xxx.xxx.xxx.xxx”替换为服务器的ip, server_port段填ss的服务器端口，如8888 password段和method分别对应密码和加密方式创建ss服务并允许自启动sudo vim /etc/systemd/system/ss-redir.service填入以下内容：Description=ss-redirWants=network.targetAfter=syslog.target network-online.target[Service]Type=simpleEnvironment=GOGC=20ExecStart=/usr/bin/ss-redir -c /etc/shadowsocks-libev/config.json -b 0.0.0.0 -u -f /var/run/ss-redir.pidRestart=on-failureRestartSec=10KillMode=process[Install]WantedBy=multi-user.target使能ss-redir服务自启动sudo systemctl daemon-reloadsudo systemctl enable ss-redir.service/* 启动 ss-redir */sudo systemctl start ss-redir.service使用dnsmasq和chinadns防止DNS污染安装配置dnsmasqsudo apt-get install dnsmasq 修改dnsmasq配置文件sudo vim /etc/dnsmasq.conf最后追加如下内容no-resolvserver=127.0.0.1#5354dnsmasq自启动服务sudo systemctl enable dnsmasq.servicesudo systemctl start dnsmasq.service安装chinadnssudo wget https://github.com/shadowsocks/ChinaDNS/releases/download/1.3.2/chinadns-1.3.2.tar.gzsudo tar -xvf chinadns-1.3.2.tar.gzcd chinadns-1.3.2./configure &amp;amp;&amp;amp; makesudo cp ./src/chinadns /usr/local/bin更新chnroute.txt列表chnroute.txt中存放的是国内范围的ip地址，可能不是最新的版本，所以最好更新一下。sudo curl -0 &#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#39; | grep ipv4 | grep CN | awk -F\\| &#39;{ printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) }&#39; &amp;gt; /etc/chnroute.txt创建chinadns自启动服务sudo vim /etc/systemd/system/chinadns.service输入以下内容Description=chinadnsWants=network.targetAfter=syslog.target network-online.target[Service]Type=simpleEnvironment=GOGC=20ExecStart=/usr/local/bin/chinadns -c /etc/chnroute.txt -m -p 5354 -s 114.114.114.114,8.8.8.8Restart=on-failureRestartSec=10KillMode=process[Install]WantedBy=multi-user.target使能并启动chinadnssudo systemctl daemon-reloadsudo systemctl enable chinadns.servicesudo systemctl start chinadns.service 测试一下dns能否使用sudo apt-get install dnsutilssudo dig www.pixiv.net @127.0.0.1 -p 53如果有内容返回，说明dns可以工作了使用ipset和iptables设置规则转发安装ipsetsudo apt-get install ipset创建配置脚本sudo vim /usr/local/bin/ipset_generate.sh填入以下内容#!/bin/sh# 删除以下4行注释运行一次，可以更新chnroute.txt列表#sudo rm /etc/chnroute.txt#sudo rm /etc/ipset.chnip#sudo rm /etc/iptables.tproxy#sudo curl -0 &#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&#39; | grep ipv4 | grep CN | awk -F\\| &#39;{ printf(&quot;%s/%d\\n&quot;, $4, 32-log($5)/log(2)) }&#39; &amp;gt; /etc/chnroute.txtif [ -e /etc/ipset.chnip ]; thenipset restore -f /etc/ipset.chnipelseipset -N chnip hash:netfor i in `cat /etc/chnroute.txt`; do echo ipset -A chnip $i &amp;gt;&amp;gt; chnip.sh; donebash chnip.shfi# 持久化 chnip 表ipset -S chnip &amp;gt; /etc/ipset.chnipif [ -e /etc/iptables.tproxy ]; theniptables-restore &amp;lt; /etc/iptables.tproxyelse# 新建 mangle/SS-UDP 链，用于透明代理内网 udp 流量iptables -t mangle -N SS-UDP# 放行保留地址、环回地址、特殊地址iptables -t mangle -A SS-UDP -d 0/8 -j RETURNiptables -t mangle -A SS-UDP -d 127/8 -j RETURNiptables -t mangle -A SS-UDP -d 10/8 -j RETURNiptables -t mangle -A SS-UDP -d 169.254/16 -j RETURNiptables -t mangle -A SS-UDP -d 172.16/12 -j RETURNiptables -t mangle -A SS-UDP -d 192.168/16 -j RETURNiptables -t mangle -A SS-UDP -d 224/4 -j RETURNiptables -t mangle -A SS-UDP -d 240/4 -j RETURN# 放行发往 ss 服务器的数据包，注意替换为你的服务器IPiptables -t mangle -A SS-UDP -d xxx.xxx.xxx.xxx -j RETURN# 放行大陆地址iptables -t mangle -A SS-UDP -m set --match-set chnip dst -j RETURN# 重定向 udp 数据包至 5300 监听端口iptables -t mangle -A SS-UDP -p udp -j TPROXY --tproxy-mark 0x2333/0x2333 --on-ip 127.0.0.1 --on-port 5300# 内网 udp 数据包流经 SS-UDP 链iptables -t mangle -A PREROUTING -p udp -s 192.168/16 -j SS-UDP# 新建 nat/SS-TCP 链，用于透明代理本机/内网 tcp 流量iptables -t nat -N SS-TCP# 放行环回地址，保留地址，特殊地址iptables -t nat -A SS-TCP -d 0/8 -j RETURNiptables -t nat -A SS-TCP -d 127/8 -j RETURNiptables -t nat -A SS-TCP -d 10/8 -j RETURNiptables -t nat -A SS-TCP -d 169.254/16 -j RETURNiptables -t nat -A SS-TCP -d 172.16/12 -j RETURNiptables -t nat -A SS-TCP -d 192.168/16 -j RETURNiptables -t nat -A SS-TCP -d 224/4 -j RETURNiptables -t nat -A SS-TCP -d 240/4 -j RETURN# 放行发往 ss 服务器的数据包，注意替换为你的服务器IPiptables -t nat -A SS-TCP -d xxx.xxx.xxx.xxx -j RETURN# 放行大陆地址段iptables -t nat -A SS-TCP -m set --match-set chnip dst -j RETURN# 重定向 tcp 数据包至 1080 监听端口iptables -t nat -A SS-TCP -p tcp -j REDIRECT --to-ports 1080# 本机 tcp 数据包流经 SS-TCP 链iptables -t nat -A OUTPUT -p tcp -j SS-TCP# 内网 tcp 数据包流经 SS-TCP 链iptables -t nat -A PREROUTING -p tcp -s 192.168/16 -j SS-TCP# 内网数据包源 NATiptables -t nat -A POSTROUTING -s 192.168/16 -j MASQUERADEfi# 持久化 iptables 规则iptables-save &amp;gt; /etc/iptables.tproxy其中xxx.xxx.xxx.xxx替换为自己服务器ip创建ipset自启动服务sudo vim /etc/systemd/system/ipset_iptables.service填入以下内容：Description=ipset_iptablesWants=network.targetAfter=syslog.target network-online.target[Service]Type=simpleEnvironment=GOGC=20ExecStart=/usr/local/bin/ipset_generate.shRestart=on-failureRestartSec=10KillMode=process[Install]WantedBy=multi-user.target使能并开启ipset_iptables服务sudo systemctl daemon-reloadsudo systemctl enable ipset_iptables.servicesudo systemctl start ipset_iptables.service修改树莓派ipsudo vim /boot/cmdline.txt添加一条内容: ip=192.168.2.4再设置默认网关为光猫的ipsudo route add default gw 192.168.2.1 eth0测试效果 树莓派和路由器都用网线连接到光猫 设置路由器联网方式为静态ip方式 配置路由器wan口的网关地址和dns地址，都设为树莓派地址（192.168.2.4） 保存设置后重启路由器 通过路由器连接上网，测试可以访问www.google.com恭喜可以愉快的查资料了！！！" }, { "title": "疫情随笔一", "url": "/posts/yiqingsuibi_1/", "categories": "essay", "tags": "随笔", "date": "2022-03-30 18:05:02 +0800", "snippet": "道宽人稀风微冷&amp;emsp;不见晴空不见明&amp;emsp;莫言三月春未至&amp;emsp;垂丝海棠一点红&amp;emsp;下南2022年3月30日于上海疫情封闭中" } ]
